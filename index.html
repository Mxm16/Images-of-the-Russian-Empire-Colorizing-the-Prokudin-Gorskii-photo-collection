<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Images of the Russian Empire: Colorizing the Prokudin-Gorskii photo collection</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; background: #fafafa; line-height: 1.6; }
    h1 { color: #2c3e50; }
    h2, h3 { color: #34495e; margin-top: 30px; }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .result {
      background: #fff;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .result img {
      width: 100%;
      border-radius: 8px;
    }
    .offset {
      color: #888;
      font-size: 0.9em;
    }
    table {
      border-collapse: collapse;
      margin-top: 15px;
      width: 100%;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px 12px;
      text-align: center;
    }
    th {
      background: #ecf0f1;
    }
  </style>
</head>
<body>
  <h1>Images of the Russian Empire: Colorizing the Prokudin-Gorskii photo collection</h1>

  <h2>Brief Approach</h2>
  <p>
    Before alignment:
  </p>
  <p>
    The main script chooses between single-scale alignment and pyramid alignment based on
    either the filename extension or the image height.
  </p>
  <ul>
    <li><strong>If the input is .jpg or has height smaller than 2000</strong> —
        Use single-scale <em>align</em>.</li>
    <li><strong>If the input is .tif or has height larger than 2000</strong> —
        Use <em>align_pyramid</em>.</li>
  </ul>

  <p>
    Alignment:
  </p>
  <ul>
    <li><b>Small images (.jpg):</b> aligned by exhaustive search within ±15 pixels using SSD as the similarity metric.</li>
    <li><b>Large images (.tif):</b> aligned using a multi-level pyramid. The image is downsampled, roughly aligned at the coarsest level, then shifts are refined at each higher resolution until full scale.</li>
  </ul>
  
  <p>
    After alignment:
  </p>
  <ul>
    <li>The Blue channel is kept fixed as reference.</li>
    <li>The aligned Green and Red channels are stacked with Blue to form an RGB image.</li>
    <li>The pixel values are clipped to [0,1] and converted to 8-bit before saving the final result.</li>
  </ul>

  <h2>Results on Provided Images</h2>

  <h3>Small Images (.jpg)</h3>
  <ul>
    <li><strong>ssd(im1, im2)</strong> —
      Computes the <em>sum of squared differences</em> between two patches:
      each pixel difference is squared and then summed.
      This is equivalent to the squared L2 norm of their difference:
      <code>SSD(I1, I2) = Σ (I1 - I2)²</code>.
      A smaller value indicates better alignment.
      SSD is simple and efficient when brightness and contrast are consistent across channels.</li>
  
    <li><strong>ncc(im1, im2)</strong> —
      Computes the <em>normalized cross-correlation</em>:
      each patch is mean-centered, then their dot product is divided by the product of their magnitudes.
      The result lies between -1 and 1, with higher values indicating better alignment:
      <code>NCC(I1, I2) = (Σ (I1-μ1)(I2-μ2)) / (||I1-μ1||·||I2-μ2||)</code>.
      NCC is more robust than SSD when overall brightness or contrast differs between channels.</li>
  </ul>


  <h4>Single-Scale Alignment Routine</h4>
  <p>
    The <em>align(im1, im2, max_shift=15, metric="ssd")</em> routine is the core exhaustive search method. Its inputs are:
    a candidate channel (to be shifted), a reference channel, the maximum shift window, and the chosen metric (SSD or NCC).
  </p>
  <ol>
    <li><strong>Crop margins</strong> — Both channels are cropped by a fixed number of pixels
        (default: 40) from all sides. This ensures that border artifacts caused by shifting do not bias the score.</li>

    <li><strong>Initialize best score</strong> — For SSD, the initial best score is set to infinity
        (because we want to minimize it). For NCC, it is set to negative infinity
        (because we want to maximize it).</li>

    <li><strong>Exhaustive search</strong> — The algorithm tries all integer displacements (dy, dx)
        within ±15 pixels (by default). For each displacement:
      <ul>
        <li>Shift the candidate channel using array rolling.</li>
        <li>Crop the shifted result with the same margin size.</li>
        <li>Compute similarity score using the chosen metric.</li>
        <li>If the score is better than the current best, update the best score, record the shift, and keep the shifted image.</li>
      </ul>
    </li>

    <li><strong>Return aligned channel and shift</strong> — After the loop finishes, the routine returns the shifted channel
        and the best (dy, dx).</li>
  </ol>
  
  <h3>Displacements</h3>
  <table>
    <tr>
      <th>Image</th>
      <th>Method</th>
      <th>Green Shift (dy, dx)</th>
      <th>Red Shift (dy, dx)</th>
    </tr>
    <tr><td>cathedral</td><td>align()</td><td>(5, 2)</td><td>(12, 3)</td></tr>
    <tr><td>monastery</td><td>align()</td><td>(-3, 2)</td><td>(3, 2)</td></tr>
    <tr><td>tobolsk</td><td>align()</td><td>(3, 3)</td><td>(6, 3)</td></tr>
  </table>

  <div class="grid">
    <div class="result">
      <p><b>Cathedral</b> <span class="offset">(G=(5,2), R=(12,3))</span></p>
      <img src="results/out_cathedral.jpg" alt="Cathedral result">
    </div>
    <div class="result">
      <p><b>Monastery</b> <span class="offset">(G=(-3,2), R=(3,2))</span></p>
      <img src="results/out_monastery.jpg" alt="Monastery result">
    </div>
    <div class="result">
      <p><b>Tobolsk</b> <span class="offset">(G=(3,3), R=(6,3))</span></p>
      <img src="results/out_tobolsk.jpg" alt="Tobolsk result">
    </div>
  </div>

  <h3>Large Images (.tif)</h3>
  <h4>Pyramid Alignment Routine</h4>
  <p>
    The <em>align_pyramid(im1, im2, max_shift=15, metric="ssd", scale=0.5, min_size=400)</em> routine applies a coarse-to-fine strategy, designed for very large images (.tif).
    Its inputs include the two channels, the search window, the metric, the downsample scale (default 0.5),
    and the stopping size (default ≈ 400 pixels).
  </p>
  <ol>
    <li><strong>Base case</strong> — If the image is already small enough
        (height or width ≤ stopping size), run the single-scale <em>align</em> directly and return the result.</li>

    <li><strong>Recursive downsampling</strong> — Otherwise, downsample both images by the scale factor (e.g. half size).
        Call <em>align_pyramid</em> recursively on these smaller versions.</li>

    <li><strong>Upscale shift</strong> — The coarse shift obtained at the smaller level
        is multiplied by the reciprocal of the scale (e.g. ×2 if scale=0.5) to estimate the displacement at the current level.</li>

    <li><strong>Apply coarse shift</strong> — Roll the candidate channel by the scaled coarse shift.</li>

    <li><strong>Local refinement</strong> — Run a single-scale <em>align</em> again on the coarse-shifted image,
        but now with a very small window (±4 pixels). This refines residual errors that coarse alignment could not capture.</li>

    <li><strong>Combine shifts</strong> — Add the coarse shift and the refinement shift together to obtain the final displacement.</li>

    <li><strong>Return aligned channel and total shift</strong>.</li>
  </ol>

  <h3>Displacements</h3>
  <table>
    <tr>
      <th>Image</th>
      <th>Method</th>
      <th>Green Shift (dy, dx)</th>
      <th>Red Shift (dy, dx)</th>
    </tr>
    <tr><td>church</td><td>align_pyramid()</td><td>(24, -2)</td><td>(55, -10)</td></tr>
    <tr><td>emir</td><td>align_pyramid()</td><td>(44, 18)</td><td>(105, 36)</td></tr>
    <tr><td>harvesters</td><td>align_pyramid()</td><td>(59, 10)</td><td>(123, 8)</td></tr>
    <tr><td>icon</td><td>align_pyramid()</td><td>(41, 16)</td><td>(89, 22)</td></tr>
    <tr><td>italil</td><td>align_pyramid()</td><td>(38, 18)</td><td>(77, 34)</td></tr>
    <tr><td>lastochikino</td><td>align_pyramid()</td><td>(-3, -2)</td><td>(74, -7)</td></tr>
    <tr><td>lugano</td><td>align_pyramid()</td><td>(40, -12)</td><td>(93, -28)</td></tr>
    <tr><td>melons</td><td>align_pyramid()</td><td>(83, 4)</td><td>(177, 8)</td></tr>
    <tr><td>self_portrait</td><td>align_pyramid()</td><td>(77, 20)</td><td>(174, 30)</td></tr>
    <tr><td>siren</td><td>align_pyramid()</td><td>(48, -7)</td><td>(101, -20)</td></tr>
    <tr><td>three_generations</td><td>align_pyramid()</td><td>(52, 8)</td><td>(110, 7)</td></tr>
  </table>

  <div class="grid">
    <div class="result">
      <p><b>Church</b> <span class="offset">(G=(24,-2), R=(55,-10))</span></p>
      <img src="results/out_church.jpg" alt="Church result">
    </div>
    <div class="result">
      <p><b>Emir</b> <span class="offset">(G=(44,18), R=(105,36))</span></p>
      <img src="results/out_emir.jpg" alt="Emir result">
    </div>
    <div class="result">
      <p><b>Harvesters</b> <span class="offset">(G=(59,10), R=(123,8))</span></p>
      <img src="results/out_harvesters.jpg" alt="Harvesters result">
    </div>
    <div class="result">
      <p><b>Icon</b> <span class="offset">(G=(41,16), R=(89,22))</span></p>
      <img src="results/out_icon.jpg" alt="Icon result">
    </div>
      <div class="result">
      <p><b>Italil</b> <span class="offset">(G=(38,18), R=(77,34))</span></p>
      <img src="results/out_italil.jpg" alt="Italil result">
    </div>
    <div class="result">
      <p><b>Lastochikino</b> <span class="offset">(G=(-3,-2), R=(74,-7))</span></p>
      <img src="results/out_lastochikino.jpg" alt="Lastochikino result">
    </div>
    <div class="result">
      <p><b>Lugano</b> <span class="offset">(G=(40,-12), R=(93,-28))</span></p>
      <img src="results/out_lugano.jpg" alt="Lugano result">
    </div>
    <div class="result">
      <p><b>Melons</b> <span class="offset">(G=(83,4), R=(177,8))</span></p>
      <img src="results/out_melons.jpg" alt="Melons result">
    </div>
    <div class="result">
      <p><b>Self Portrait</b> <span class="offset">(G=(77,20), R=(174,30))</span></p>
      <img src="results/out_self_portrait.jpg" alt="Self Portrait result">
    </div>
    <div class="result">
      <p><b>Siren</b> <span class="offset">(G=(48,-7), R=(101,-20))</span></p>
      <img src="results/out_siren.jpg" alt="Siren result">
    </div>
    <div class="result">
      <p><b>Three Generations</b> <span class="offset">(G=(52,8), R=(110,7))</span></p>
      <img src="results/out_three_generations.jpg" alt="Three Generations result">
    </div>
  </div>
  
  <h2>Results on Extra Images Downloaded from the Prokudin-Gorskii Collection</h2>
  
  <h3>Displacements</h3>
  <table border="1" cellpadding="6" cellspacing="0">
    <tr>
      <th>Image</th>
      <th>Method</th>
      <th>Green Shift (dy, dx)</th>
      <th>Red Shift (dy, dx)</th>
    </tr>
    <tr>
      <td>suna_river</td>
      <td>align()</td>
      <td>(1, 0)</td>
      <td>(8, -1)</td>
    </tr>
    <tr>
      <td>sign</td>
      <td>align()</td>
      <td>(4, -1)</td>
      <td>(10, -4)</td>
    </tr>
    <tr>
      <td>kumsa_river</td>
      <td>align()</td>
      <td>(2, 3)</td>
      <td>(9, 4)</td>
    </tr>
    <tr>
      <td>religious_painting</td>
      <td>align_pyramid()</td>
      <td>(25, 3)</td>
      <td>(69, 7)</td>
    </tr>
    <tr>
      <td>religious_painting2</td>
      <td>align_pyramid()</td>
      <td>(34, 20)</td>
      <td>(55, 32)</td>
    </tr>
    <tr>
      <td>three_mannequins</td>
      <td>align_pyramid()</td>
      <td>(54, -2)</td>
      <td>(112, -17)</td>
    </tr>
  </table>
  
  <div class="grid">
    <div class="result">
      <p><b>Suna River</b> <span class="offset">(G=(1,0), R=(8,-1))</span></p>
      <img src="results/out_suna_river.jpg" alt="Suna_river result">
    </div>
    <div class="result">
      <p><b>Kumsa River</b> <span class="offset">(G=(2,3), R=(9,4))</span></p>
      <img src="results/out_kumsa_river.jpg" alt="Kumsa_river result">
    </div>
    <div class="result">
      <p><b>Sign</b> <span class="offset">(G=(4,-1), R=(10,-4))</span></p>
      <img src="results/out_sign.jpg" alt="Sign result">
    </div>
    <div class="result">
      <p><b>Three Mannequins</b> <span class="offset">(G=(54,-2), R=(112,-17))</span></p>
      <img src="results/out_three_mannequins.jpg" alt="Three_mannequins result">
    </div>
    <div class="result">
      <p><b>Religious Painting</b> <span class="offset">(G=(25,3), R=(69,7))</span></p>
      <img src="results/out_religious_painting.jpg" alt="Religious_painting result">
    </div>
      <div class="result">
    <p><b>Religious Painting2</b> <span class="offset">(G=(34,20), R=(55,32))</span></p>
    <img src="results/out_religious_painting2.jpg" alt="Religious_painting2 result">
    </div>
  </div>
